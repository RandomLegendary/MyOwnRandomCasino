<button id="claimBtn">Claim $1000</button>
<span id="msg"></span>

<script>
  const btn = document.getElementById('claimBtn');
  const msg = document.getElementById('msg');

  async function updateUIAfterResponse(json) {
    if (json.success) {
      msg.textContent = `You received $${json.added}! Balance: $${json.balance}`;
      startCooldown(24 * 60 * 60 * 1000); // 24h
    } else if (json.error === 'Cooldown' || json.msLeft) {
      const msLeft = json.msLeft ?? (new Date(json.nextAvailable).getTime() - Date.now());
      startCooldown(msLeft);
      msg.textContent = `Next available: ${new Date(Date.now() + msLeft).toLocaleString()}`;
    } else {
      msg.textContent = 'Error: ' + (json.error || 'unknown');
    }
  }

  function formatMs(ms) {
    const s = Math.floor(ms / 1000) % 60;
    const m = Math.floor(ms / (1000 * 60)) % 60;
    const h = Math.floor(ms / (1000 * 60 * 60));
    return `${h}h ${m}m ${s}s`;
  }

  let cooldownTimer = null;
  function startCooldown(ms) {
    btn.disabled = true;
    if (cooldownTimer) clearInterval(cooldownTimer);
    let remaining = ms;
    cooldownTimer = setInterval(() => {
      if (remaining <= 0) {
        clearInterval(cooldownTimer);
        btn.disabled = false;
        msg.textContent = 'You can claim your daily again!';
        return;
      }
      msg.textContent = 'Next claim in: ' + formatMs(remaining);
      remaining -= 1000;
    }, 1000);
  }

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    msg.textContent = 'Claiming...';
    try {
      const res = await fetch('/api/claim-daily', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
      const json = await res.json();
      await updateUIAfterResponse(json);
    } catch (err) {
      console.error(err);
      msg.textContent = 'Network error';
      btn.disabled = false;
    }
  });

  // OPTIONALLY: when page loads, ask server if the user is on cooldown to set UI correctly
  async function checkStatus() {
    try {
      const res = await fetch('/api/daily-status'); // optional endpoint below
      if (!res.ok) return;
      const json = await res.json();
      if (json.msLeft && json.msLeft > 0) startCooldown(json.msLeft);
    } catch (e) { /* ignore */ }
  }
  checkStatus();
</script>
